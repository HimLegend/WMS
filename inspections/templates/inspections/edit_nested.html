{% extends 'core/base.html' %}
{% load static %}
{% block title %}Edit Inspection Report #{{ report.id }}{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inspection_edit.css' %}">
{% endblock %}
{% load crispy_forms_tags %}


{% block content %}
<div class="container mt-5 mb-5">
    <h2 class="mb-4">Edit Inspection Report #{{ report.id }}</h2>
    <form method="post" id="inspection-form">
        {% csrf_token %}

        <!-- Display Jobcard info (if available) -->
        {% if report.job_card %}
        <div class="mb-4">
            <label class="form-label fw-bold">Job Card: {{ report.job_card }}</label>
            <input type="hidden" name="job_card_id" value="{{ report.job_card.id }}">
        </div>
        <div class="card-body mb-4">
            <div class="col-md-6">
                <h6 class="text-success"><i class="fas fa-car me-2"></i>Vehicle</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>Make:</strong> {{ report.job_card.vehicle.make }}</li>
                            <li><strong>Model:</strong> {{ report.job_card.vehicle.model }}</li>
                            <li><strong>Year:</strong> {{ report.job_card.vehicle.year }}</li>
                            <li><strong>Color:</strong> {{ report.job_card.vehicle.color }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><strong>Plate:</strong> {{ report.job_card.vehicle.plate }}</li>
                            <li><strong>VIN:</strong> {{ report.job_card.vehicle.vin }}</li>
                            <li><strong>Mileage:</strong> {{ report.job_card.vehicle.mileage }} km</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Inspection Report Main Fields -->
        <div class="card mb-4 p-3">
            <h5>Inspection Report Details</h5>
            {{ report_form.as_p }}
        </div>

        <!-- Findings Section -->
        <div id="findings-container">
            {% for finding_form in finding_formset.forms %}
            <div class="card mt-4 finding-item border">
                <div class="card-body position-relative">
                    <button type="button" class="btn-close position-absolute top-0 end-0 remove-finding"
                        aria-label="Remove finding"></button>
                    <h5 class="card-title">Finding {{ forloop.counter }}</h5>
                    {{ finding_form.id }}
                    {{ finding_form.DELETE }}

                    <div class="mb-2">
                        {{ finding_form.description.label_tag }}{{ finding_form.description }}
                    </div>
                    <div class="mb-2">
                        {{ finding_form.severity.label_tag }}{{ finding_form.severity }}
                    </div>
                    <div class="mb-2">
                        {{ finding_form.time_required.label_tag }}{{ finding_form.time_required }}
                    </div>
                    <div class="mb-2">
                        {{ finding_form.remarks.label_tag }}{{ finding_form.remarks }}
                    </div>

                    <!-- Parts nested -->
                    <div class="nested-section mt-3">
                        <h6>Parts</h6>
                        <div class="parts-container">
                            {% for part_form in part_formsets.forloop.parentloop.counter0.forms %}
                            {% if forloop.parentloop.counter0 == forloop.parentloop.parentloop.counter0 %}
                            <div class="row mb-2 part-item">
                                {{ part_form.id }}
                                {{ part_form.DELETE }}
                                <div class="col">
                                    {{ part_form.part_number.label_tag }}{{ part_form.part_number }}
                                </div>
                                <div class="col">
                                    {{ part_form.description.label_tag }}{{ part_form.description }}
                                </div>
                                <div class="col-2">
                                    {{ part_form.quantity.label_tag }}{{ part_form.quantity }}
                                </div>
                                <div class="col">
                                    {{ part_form.status.label_tag }}{{ part_form.status }}
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-danger remove-part">✕</button>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-part">+ Add Part</button>
                    </div>

                    <!-- Consumables nested -->
                    <div class="nested-section mt-3">
                        <h6>Consumables</h6>
                        <div class="consumables-container">
                            {% for consumable_form in consumable_formsets.forloop.parentloop.counter0.forms %}
                            {% if forloop.parentloop.counter0 == forloop.parentloop.parentloop.counter0 %}
                            <div class="row mb-2 consumable-item">
                                {{ consumable_form.id }}
                                {{ consumable_form.DELETE }}
                                <div class="col">
                                    {{ consumable_form.name.label_tag }}{{ consumable_form.name }}
                                </div>
                                <div class="col-2">
                                    {{ consumable_form.quantity.label_tag }}{{ consumable_form.quantity }}
                                </div>
                                <div class="col-2">
                                    {{ consumable_form.unit.label_tag }}{{ consumable_form.unit }}
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-danger remove-consumable">✕</button>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-consumable">+ Add
                            Consumable</button>
                    </div>

                </div>
            </div>
            {% empty %}
            <p>No findings found. Use the button below to add.</p>
            {% endfor %}
        </div>

        <button type="button" class="btn btn-outline-primary mt-3" id="add-finding">+ Add Finding</button>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">Save Report</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/inspection_edit.js' %}"></script>
{% endblock %}